---
title: "Monthly Quiz"
format: 
  html:
    css: custom.css
---
<div id="exam-content">
::: {#instructions .info-section}
### Instructions for Students {.unnumbered}

Welcome to the monthly quiz! ğŸ“ 

Please read the following instructions carefully:

- ğŸ“‹ Enter your full name exactly as it appears in the course registration system (è¯·ä½¿ç”¨ä¸æ•°åŒ—é€‰è¯¾ç³»ç»Ÿå®Œå…¨ä¸€è‡´çš„å§“å).
- â±ï¸ Important: After clicking 'Submit' at the end of the quiz, you cannot retake or resubmit the quiz.
- ğŸŒ Ensure you have a stable internet connection before starting the quiz.
- ğŸ”’ Do not close the browser window during the quiz.
- ğŸ†˜ If you encounter any technical issues, please contact Meng via WeChat.

Good luck! ğŸ€
:::


::: {#student-info .info-section}
### Student Information {.unnumbered}

::: {.form-group}
<label for="student-name">Name:
  <br>
  <small>Enter your name exactly as it appears in the course registration system (è¯·å¡«å†™ä¸æ•°åŒ—é€‰è¯¾ç³»ç»Ÿä¸€è‡´çš„å§“å).</small>
  <br>
<input type="text" id="student-name" class="form-control" placeholder="Enter your name here">
<br>
:::

<button id="start-quiz-button" class="btn btn-primary">Start Quiz</button>
:::

<div id="exam-container" style="display: none;"></div>
<div id="exam-results" class="info-section" style="display: none;"></div>

<!-- Main script -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="book/examQuestions.js"></script>
<script src="book/quiz.js"></script>
<script src="book/content-switch.js"></script>

<script>
console.log('exam.qmd script starting');

// Set this to true for testing, false for normal operation
const testMode = false;

let verifiedStudent = null;
let quizSubmitted = false;

window.addEventListener('load', function() {
  console.log('Window loaded, initializing Supabase...');
  
  // Check if Supabase is loaded
  if (typeof supabase === 'undefined') {
    console.error('Error: Supabase library not loaded');
    return;
  }

  // Initialize Supabase client
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_API_KEY);
  console.log('Supabase client initialized:', supabaseClient);

  // Initialize page
  initializePage(supabaseClient);
});

async function initializePage(supabaseClient) {
  console.log('Initializing page');
  
  // Fetch exam settings
  const { data, error } = await supabaseClient
    .from('exam_settings')
    .select('*')
    .single();
  
  if (error) {
    console.error('Error fetching exam settings:', error);
    return;
  }
  
  const examStartTime = new Date(data.exam_start_time);
  const examEndTime = new Date(data.exam_end_time);
  
  // Get current time in GMT+8
  const currentTimeGMT8 = new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Shanghai' }));

  const isExamPeriod = testMode || (currentTimeGMT8 >= examStartTime && currentTimeGMT8 <= examEndTime);

  if (testMode) {
    console.log('Test mode active: Exam period forced on');
  }

  switchContent(isExamPeriod, data);
  
  if (isExamPeriod) {
    const startQuizButton = document.getElementById('start-quiz-button');
    if (startQuizButton) {
      startQuizButton.addEventListener('click', () => verifyStudent(supabaseClient));
      console.log('Click event listener added to Start Quiz button');
    } else {
      console.error('Start Quiz button not found');
    }
  }
}

function switchContent(isExamPeriod, examData) {
  const examContent = document.getElementById('exam-content');
  const nonExamContent = document.getElementById('non-exam-content');
  const examPeriodElement = document.getElementById('exam-period');
  const contentCoverageElement = document.getElementById('content-coverage');
  
  if (isExamPeriod) {
    examContent.style.display = 'block';
    nonExamContent.style.display = 'none';
  } else {
    examContent.style.display = 'none';
    nonExamContent.style.display = 'block';
    if (examPeriodElement) {
      examPeriodElement.textContent = `${formatDate(new Date(examData.exam_start_time))} to ${formatDate(new Date(examData.exam_end_time))}`;
    }
    if (contentCoverageElement) {
      contentCoverageElement.textContent = examData.content_coverage;
    }
  }
}

function formatDate(date) {
  return date.toLocaleString('en-US', { 
    timeZone: 'Asia/Shanghai',
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    hour12: false
  });
}

async function verifyStudent(supabaseClient) {
  console.log('verifyStudent function called');
  if (!supabaseClient) {
    console.error('Supabase client not initialized');
    alert('An error occurred. Please refresh the page and try again.');
    return;
  }
  
  const studentName = document.getElementById('student-name').value;
  
  console.log('Student Name:', studentName);

  if (!studentName) {
    alert('è¯·è¾“å…¥ä½ çš„å§“åã€‚');
    return;
  }
  
  try {
    // Check if student exists in users table
    const { data: user, error: userError } = await supabaseClient
      .from('users')
      .select()
      .eq('name', studentName)
      .single();

    if (userError) throw userError;

    if (!user) {
      alert('æœªæ‰¾åˆ°å­¦ç”Ÿä¿¡æ¯ã€‚è¯·æ£€æŸ¥ä½ è¾“å…¥çš„å§“åæ˜¯å¦æ­£ç¡®ã€‚');
      return;
    }

    // Check if student has already submitted the exam
    const { data: examResult, error: examError } = await supabaseClient
      .from('examresults')
      .select()
      .eq('name', studentName)
      .maybeSingle();

    if (examError) throw examError;

    if (examResult) {
      alert('ä½ å·²ç»æäº¤è¿‡æœ¬æ¬¡è€ƒè¯•çš„ç­”æ¡ˆï¼Œä¸èƒ½å†æ¬¡å‚åŠ è€ƒè¯•ã€‚');
      return;
    }

    // If both checks pass, proceed with the exam
    verifiedStudent = user;
    document.getElementById('student-info').style.display = 'none';
    document.getElementById('exam-container').style.display = 'block';
    
    if (typeof createExam === 'function') {
      console.log('Calling createExam');
      createExam(supabaseClient, verifiedStudent);
    } else {
      console.error('createExam is not a function. Check quiz.js');
      alert('An error occurred while starting the exam. Please contact support.');
    }

  } catch (error) {
    console.error('Error verifying student:', error);
    alert('æœªæ‰¾åˆ°å­¦ç”Ÿä¿¡æ¯ã€‚è¯·æ£€æŸ¥ä½ è¾“å…¥çš„å§“åæ˜¯å¦æ­£ç¡®ã€‚');
  }
}

console.log('exam.qmd script finished loading');
</script>
</div>
<div id="non-exam-content" style="display: none;">
::: {#instructions .info-section}
### Information about the Quiz {.unnumbered}

ğŸ“ **Quiz Format**:

- 10 questions in total
- All questions are taken from the course textbook
- Multiple choice format

â° **Quiz Schedule**:

- The quiz is currently closed
- It will be open from <strong><span id="exam-period"></span></strong>
- You can submit any time during this period
- You can only submit the quiz once

ğŸ“š **Content Coverage**:

- <strong><span id="content-coverage"></span></strong>

Good luck and happy studying! ğŸ€ğŸ“š
:::
</div>
