---
title: "Monthly Quiz"
format: html
---

<div id="student-info">
  <h2>Student Information</h2>
  <input type="text" id="student-name" placeholder="Enter your name in Chinese">
  <button onclick="verifyStudent()">Verify</button>
</div>

<div id="exam-container"></div>
<div id="exam-results"></div>
<div id="exam-analysis"></div>

<!-- Add this line to explicitly include the analysis button -->
<button id="show-analysis-button" style="display: block; margin-top: 20px;">Show Analysis</button>

<!-- Update the script src to point to the correct location -->
<script src="examAnalysis.js"></script>
<script src="book/quiz.js"></script>

<script>
console.log('After loading examAnalysis.js:');
console.log('analyzeExamResults function:', typeof window.analyzeExamResults);
console.log('displayAnalysis function:', typeof window.displayAnalysis);

let verifiedStudent = null;

async function verifyStudent() {
  console.log('verifyStudent function called');
  const studentName = document.getElementById('student-name').value;
  console.log('Student name:', studentName);
  
  if (!studentName) {
    alert('Please enter your name.');
    return;
  }
  
  try {
    const response = await fetch(`https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/Users?filterByFormula={Name}='${studentName}'`, {
      headers: {
        'Authorization': `Bearer ${AIRTABLE_API_KEY}`
      }
    });
    const data = await response.json();
    
    if (data.records.length > 0) {
      verifiedStudent = data.records[0];
      document.getElementById('student-info').style.display = 'none';
      document.getElementById('exam-container').style.display = 'block';
      createExam(verifiedStudent);
      // Show the analysis button after exam creation
      document.getElementById('show-analysis-button').style.display = 'block';
    } else {
      alert('Student not found. Please check your name.');
    }
  } catch (error) {
    console.error('Error verifying student:', error);
    alert('An error occurred while verifying your information. Please try again.');
  }
}

function createExam(student) {
  createQuiz({
    questions: examQuestions,
    answers: examAnswers
  }, "exam-container", function(score, studentAnswers) {
    submitExamResults(student, score, studentAnswers);
    showExamResults(score, examQuestions.length);
    analyzeExamResults().then(analysisData => displayAnalysis(analysisData));
  });
}

// Sample questions for the exam
const examQuestions = [
  {
    text: "Which dplyr function would you use to select specific columns from a dataset?",
    options: [
      "filter()",
      "select()",
      "mutate()",
      "arrange()"
    ]
  },
  // Add more questions here...
];

const examAnswers = [1, /* Add more answer indices here... */];

// Initialize the exam when the document is ready
document.addEventListener('DOMContentLoaded', function() {
  console.log('Document ready, initializing exam');

  document.getElementById('show-analysis-button').addEventListener('click', function() {
    console.log('Analysis button clicked');
    if (typeof window.analyzeExamResults === 'function') {
      window.analyzeExamResults().then(analysisData => window.displayAnalysis(analysisData))
        .catch(error => console.error('Error analyzing exam results:', error));
    } else {
      console.error('analyzeExamResults function is not defined');
      alert('Analysis function is not available. Please check the console for more information.');
    }
  });
});

console.log('exam.qmd script loaded');
</script>
