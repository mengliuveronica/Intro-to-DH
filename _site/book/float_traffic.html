<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Floating Traffic Light</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: Arial, sans-serif;
            font-size: 14px;
        }
        #floating-traffic-light {
            position: fixed;
            bottom: 0.5em;
            right: 0.5em;
            background-color: rgba(255, 255, 255, 0.95);
            border: 1px solid #ccc;
            border-radius: 0.5em;
            box-shadow: 0 0.1em 0.5em rgba(0,0,0,0.1);
            width: 2.5em;
            height: 2.5em;
            overflow: hidden;
            transition: all 0.3s ease;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        #floating-traffic-light.expanded {
            width: 10em;
            height: auto;
            padding: 0.5em;
        }
        #floating-traffic-light.expanded #content {
            display: flex;
            flex-direction: column;
            gap: 0.5em;
        }
        #floating-traffic-light.expanded #current-status {
            display: none;
        }
        #current-status {
            font-size: 1.2em;
        }
        #content {
            display: none;
            width: 100%;
            text-align: center;
        }
        .traffic-light {
            display: flex;
            justify-content: space-around;
            margin: 0.5em 0;
        }
        .light {
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0.5;
        }
        .light:hover, .light.active {
            opacity: 1;
        }
        #status-message {
            text-align: center;
            font-size: 0.8em;
            color: #333;
            min-height: 1.2em;
        }
        #name-input {
            width: 100%;
            padding: 0.3em;
            border: 1px solid #ccc;
            border-radius: 0.25em;
            font-size: 0.8em;
            box-sizing: border-box;
        }
        #name-display {
            font-size: 0.8em;
            color: #4a4a4a;
            cursor: pointer;
            border: 1px solid #e0e0e0;
            border-radius: 1em;
            padding: 0.3em 0.7em;
            margin-top: 0.3em;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #ffffff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        #name-display:hover {
            border-color: #c0c0c0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        }
        #name-display::before {
            content: 'üë§';
            margin-right: 0.3em;
            font-size: 1.1em;
        }
        #name-input.invalid {
            border: 2px solid #ff4444;
        }
        #status-message.error {
            color: #ff4444;
            font-weight: bold;
            background-color: #fcf8e3;
            padding: 0.3em;
            border-radius: 0.25em;
            margin-top: 0.3em;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div id="floating-traffic-light">
        <div id="current-status">üö•</div>
        <div id="content">
            <input type="text" id="name-input" placeholder="Your name">
            <div id="name-display" style="display: none;"></div>
            <div class="traffic-light">
                <div class="light" data-status="Green" data-message="Got it!üòé">‚úÖ</div>
                <div class="light" data-status="Yellow" data-message="Hold on...ü§î">‚è≥</div>
                <div class="light" data-status="Red" data-message="Stuck...Help!üòµ‚Äçüí´">üÜò</div>
            </div>
            <div id="status-message"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://zvuouirzacmtxsmglspc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp2dW91aXJ6YWNtdHhzbWdsc3BjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjkwODM2MDUsImV4cCI6MjA0NDY1OTYwNX0.BXSeXvqW558J4qHL9AmqXbJQs7rvBIuW_3L6_GsBkjM';


        document.addEventListener('DOMContentLoaded', async function() {

            await new Promise(resolve => {
                if (window.supabase) {
                    resolve();
                } else {
                    window.addEventListener('load', resolve);
                }
            });

            const currentStatus = document.getElementById('current-status');
            const floatingTrafficLight = document.getElementById('floating-traffic-light');
            const content = document.getElementById('content');
            const statusMessage = document.getElementById('status-message');
            const nameInput = document.getElementById('name-input');
            const nameDisplay = document.getElementById('name-display');

            let lastStatus = 'üö•';

            // Add this function to save the last status
            function saveLastStatus(status) {
                localStorage.setItem('lastStatus', status);
            }

            // Add this function to load the last status
            function loadLastStatus() {
                return localStorage.getItem('lastStatus') || 'üö•';
            }

            const statusMessages = {
                'Green': "Got it!",
                'Yellow': "Hold on...",
                'Red': "Stuck...Help!"
            };

            const statusEmojis = {
                'Green': "‚úÖ",
                'Yellow': "‚è≥",
                'Red': "üÜò"
            };

            // Cache valid users
            let cachedValidUsers = null;
            const CACHE_DURATION = 24 * 60 * 60 * 1000; // 24 hours
            let lastCacheTime = 0;

            // Add Supabase client initialization
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            // Add this constant at the top of your script
            const UPDATE_WINDOW_MINUTES = 3; // Change this to your desired time window

            // Modify loadValidUsers function
            async function loadValidUsers() {
                const now = Date.now();
                if (cachedValidUsers && now - lastCacheTime < CACHE_DURATION) {
                    return cachedValidUsers;
                }

                try {
                    // First, try to load from localStorage
                    const storedCache = localStorage.getItem('validUsersCache');
                    const storedCacheTime = localStorage.getItem('validUsersCacheTime');
                    
                    if (storedCache && storedCacheTime) {
                        const cacheAge = now - parseInt(storedCacheTime, 10);
                        if (cacheAge < CACHE_DURATION) {
                            cachedValidUsers = JSON.parse(storedCache);
                            lastCacheTime = parseInt(storedCacheTime, 10);
                            console.log('Valid users loaded from localStorage cache');
                            return cachedValidUsers;
                        }
                    }

                    // If not in localStorage or expired, fetch from Supabase
                    const { data, error } = await supabase
                        .from('users')
                        .select('name');

                    if (error) throw error;

                    cachedValidUsers = data.map(user => user.name);
                    lastCacheTime = now;
                    
                    // Store in localStorage
                    localStorage.setItem('validUsersCache', JSON.stringify(cachedValidUsers));
                    localStorage.setItem('validUsersCacheTime', lastCacheTime.toString());
                    
                    console.log('Valid users loaded from Supabase and cached');
                    return cachedValidUsers;
                } catch (error) {
                    console.error('Error loading valid users:', error);
                    return [];
                }
            }

            // Add this function to clear the cache if needed
            function clearValidUsersCache() {
                cachedValidUsers = null;
                lastCacheTime = 0;
                localStorage.removeItem('validUsersCache');
                localStorage.removeItem('validUsersCacheTime');
                console.log('Valid users cache cleared');
            }

            function loadNameFromStorage() {
                const savedName = localStorage.getItem('userName');
                if (savedName) {
                    nameInput.value = savedName;
                    nameDisplay.textContent = savedName;
                    nameInput.style.display = 'none';
                    nameDisplay.style.display = 'flex';
                }
            }

            function saveNameToStorage(name) {
                localStorage.setItem('userName', name);
            }

            // Add this variable to track if the name is valid
            let isNameValid = true;

            // Modify the showInvalidNameError function
            function showInvalidNameError(message) {
                statusMessage.textContent = message;
                statusMessage.classList.add('error');
                nameInput.classList.add('invalid');
                isNameValid = false;
            }

            // Modify the clearInvalidNameError function
            function clearInvalidNameError() {
                statusMessage.classList.remove('error');
                nameInput.classList.remove('invalid');
                isNameValid = true;
            }

            // Modify the updateFloatingStatus function
            async function updateFloatingStatus(status) {
                const name = nameInput.value.trim() || nameDisplay.textContent;
                console.log('Entered name:', name);

                if (!name) {
                    showInvalidNameError('Please enter your name');
                    return;
                }

                if (document.activeElement === nameInput) {
                    statusMessage.textContent = 'Press Enter or click outside to confirm name';
                    return;
                }

                const validUsers = await loadValidUsers();
                if (!validUsers.some(user => user.localeCompare(name, 'zh', { sensitivity: 'base' }) === 0)) {
                    showInvalidNameError('Invalid name. Please enter a valid name.');
                    console.log('Name not found in valid users');
                    return;
                }

                // Clear any error styling
                clearInvalidNameError();

                console.log('Name is valid, proceeding with status update');

                try {
                    const recentRecord = await getRecentRecord(name);
                    
                    const statusData = {
                        name: name,
                        status: statusMessages[status],
                        created_at: new Date().toISOString()
                    };

                    let { data, error } = recentRecord
                        ? await supabase
                            .from('status_updates')
                            .update(statusData)
                            .eq('id', recentRecord.id)
                        : await supabase
                            .from('status_updates')
                            .insert(statusData);

                    if (error) throw error;

                    document.querySelectorAll('.light').forEach(light => {
                        light.classList.remove('active');
                    });
                    document.querySelector(`.light[data-status="${status}"]`).classList.add('active');
                    
                    lastStatus = statusEmojis[status];
                    currentStatus.textContent = lastStatus;
                    statusMessage.textContent = statusMessages[status];
                    nameDisplay.textContent = name;
                    nameInput.style.display = 'none';
                    nameDisplay.style.display = 'flex';
                    saveNameToStorage(name);
                    saveLastStatus(status); // Save the last status

                    isExpanded = false;
                    collapseFloatingObject();
                } catch (error) {
                    console.error('Error updating status:', error);
                    statusMessage.textContent = 'Error updating status';
                }
            }

            // Modify getRecentRecord function
            async function getRecentRecord(name) {
                try {
                    const windowAgo = new Date(Date.now() - UPDATE_WINDOW_MINUTES * 60 * 1000).toISOString();
                    const { data, error } = await supabase
                        .from('status_updates')
                        .select('*')
                        .eq('name', name)
                        .gte('created_at', windowAgo)
                        .order('created_at', { ascending: false })
                        .limit(1);

                    if (error) throw error;

                    return data.length > 0 ? data[0] : null;
                } catch (error) {
                    console.error('Error getting recent record:', error);
                    return null;
                }
            }

            // Add these variable declarations at the beginning of your script
            let isExpanded = false;
            let isHovering = false;
            let hoverTimeout;

            function addEventListeners() {
                document.querySelectorAll('.light').forEach(light => {
                    light.addEventListener('click', function() {
                        const status = this.getAttribute('data-status');
                        updateFloatingStatus(status);
                    });
                    light.addEventListener('mouseenter', function() {
                        if (isNameValid) {
                            statusMessage.textContent = this.getAttribute('data-message');
                        }
                    });
                    light.addEventListener('mouseleave', function() {
                        if (isNameValid) {
                            statusMessage.textContent = statusMessages[lastStatus] || '';
                        }
                    });
                });

                nameDisplay.addEventListener('dblclick', function() {
                    this.style.display = 'none';
                    nameInput.value = this.textContent;
                    nameInput.style.display = 'block';
                    nameInput.focus();
                });

                nameInput.addEventListener('blur', function() {
                    if (this.value.trim()) {
                        nameDisplay.textContent = this.value.trim();
                        this.style.display = 'none';
                        nameDisplay.style.display = 'flex';
                        saveNameToStorage(this.value.trim());
                        isExpanded = true;
                    }
                });

                nameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        this.blur();
                    }
                });

                nameInput.addEventListener('focus', function() {
                    statusMessage.textContent = 'Enter your name and press Enter';
                });

                nameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        this.blur();
                        const activeLight = document.querySelector('.light.active');
                        if (activeLight) {
                            updateFloatingStatus(activeLight.getAttribute('data-status'));
                        }
                    }
                });

                floatingTrafficLight.addEventListener('mouseenter', () => {
                    clearTimeout(hoverTimeout);
                    expandFloatingObject();
                    statusMessage.textContent = statusMessages[lastStatus] || '';
                });

                floatingTrafficLight.addEventListener('mouseleave', () => {
                    isHovering = false;
                    if (!isExpanded) {
                        hoverTimeout = setTimeout(() => {
                            collapseFloatingObject();
                        }, 2000);
                    }
                });

                document.addEventListener('mousemove', (e) => {
                    if (isExpanded && !floatingTrafficLight.contains(e.target)) {
                        isExpanded = false;
                        collapseFloatingObject();
                    }
                });
            }

            function expandFloatingObject() {
                floatingTrafficLight.classList.add('expanded');
                isHovering = true;
                isExpanded = true;
            }

            function collapseFloatingObject() {
                if (!isHovering && !isExpanded) {
                    floatingTrafficLight.classList.remove('expanded');
                }
            }

            // Modify the initialization to include an option to clear the cache
            function initialize() {
                loadValidUsers().then(() => {
                    loadNameFromStorage();
                    addEventListeners();
                    
                    // Load and set the last status
                    const savedStatus = loadLastStatus();
                    lastStatus = savedStatus;
                    currentStatus.textContent = statusEmojis[savedStatus] || 'üö•';
                    
                    // Set the active light based on the saved status
                    document.querySelectorAll('.light').forEach(light => {
                        if (light.getAttribute('data-status') === savedStatus) {
                            light.classList.add('active');
                        }
                    });
                    
                    console.log('Initialization complete');
                });
            }

            // Call the initialize function
            initialize();
    });

        // You can call this function when you need to force a refresh of the user list
        // clearValidUsersCache();
    </script>
</body>
</html>
